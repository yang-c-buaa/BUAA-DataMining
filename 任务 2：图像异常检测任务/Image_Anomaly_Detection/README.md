# 图像异常检测任务解决方案

## 作业要求

**Task 2: Image Anomaly Detection Task (图像异常检测任务)**

- 使用无监督学习方法进行图像异常检测
- 基于正常样本学习正常分布，检测测试集中的异常样本
- 生成异常热力图可视化
- 评估异常检测性能

## 数据集说明

- **数据集类型**: MVTec AD 风格数据集
- **类别**: 
  - `hazelnut` (榛子)
  - `zipper` (拉链)
- **数据结构**:
  ```
  {category}/
  ├── train/
  │   ├── good/          # 正常训练样本
  │   └── bad/           # 异常训练样本（可选）
  └── test/              # 测试样本（包含正常和异常）
  ```
- **标签文件**: `image_anomaly_labels.json`
  - 包含每个测试图像的标签信息（"good" 或 "bad"）

## 文件结构

```
Image_Anomaly_Detection/
├── hazelnut/                    # 榛子类别数据
│   ├── train/
│   │   ├── good/               # 正常训练样本
│   │   └── bad/                # 异常训练样本
│   └── test/                   # 测试样本
├── zipper/                      # 拉链类别数据
│   ├── train/
│   │   ├── good/               # 正常训练样本
│   │   └── bad/                # 异常训练样本
│   └── test/                   # 测试样本
├── image_anomaly_labels.json   # 测试集标签文件
├── main.py                      # 主程序
├── requirements.txt             # 依赖包
├── visualizations/             # 可视化结果目录
│   ├── {category}/
│   │   ├── heatmaps/           # 异常热力图
│   │   └── summary/            # 性能摘要图
└── README.md                    # 说明文档
```

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 基本使用

1. **修改配置参数**（在 `main.py` 中）:
   ```python
   CONFIG = {
       "dataset_path": "./",           # 数据集根目录
       "category": "hazelnut",          # 选择类别: 'hazelnut' 或 'zipper'
       "image_size": 256,               # 图像尺寸
       "batch_size": 16,                # 批次大小
       "device": "cuda" if torch.cuda.is_available() else "cpu",
       "visualization_dir": "visualizations"
   }
   ```

2. **运行程序**:
   ```bash
   python main.py
   ```

### 处理不同类别

要处理不同的类别，只需修改 `CONFIG["category"]` 参数：
- `"hazelnut"` - 处理榛子类别
- `"zipper"` - 处理拉链类别

## 解决方案详解

### 核心方法

本项目采用基于深度特征提取和统计建模的无监督异常检测方法：

1. **特征提取**
   - 使用预训练的 Wide ResNet50-2 模型
   - 提取 Layer2 和 Layer3 的特征图
   - 将多层特征图进行融合，获得丰富的语义特征

2. **正常分布建模**
   - 从正常训练样本中提取所有图像块的特征
   - 使用多元高斯分布（通过均值和协方差矩阵）建模正常特征分布
   - 使用马氏距离（Mahalanobis Distance）度量特征与正常分布的偏离程度

3. **异常检测**
   - 对测试图像的每个区域计算马氏距离
   - 生成异常分数图（anomaly map）
   - 图像级异常分数 = 区域异常分数的最大值

4. **可视化**
   - 生成异常热力图，显示异常区域的位置
   - 叠加到原始图像上，直观展示异常检测结果

### 技术特点

- **深度特征**: 利用预训练 CNN 提取高级语义特征
- **多尺度特征融合**: 结合不同层的特征，捕获多尺度信息
- **统计建模**: 使用多元高斯分布建模正常样本分布
- **区域级检测**: 不仅检测图像是否异常，还能定位异常区域
- **全面评估**: 使用 AUROC、ROC 曲线、混淆矩阵等指标评估性能

## 输出结果

程序会生成以下输出：

1. **控制台输出**:
   - 处理进度
   - 图像级异常检测 AUROC 分数

2. **可视化结果**:
   - **热力图** (`visualizations/{category}/heatmaps/`):
     - 每张测试图像生成一个热力图
     - 包含原始图像、异常热力图和叠加效果
   
   - **性能摘要** (`visualizations/{category}/summary/performance_summary.png`):
     - PCA 降维后的特征分布（真实标签 vs 异常分数）
     - ROC 曲线
     - 混淆矩阵

## 评估指标

- **AUROC (Area Under ROC Curve)**: 图像级异常检测的主要评估指标
  - 范围: [0, 1]
  - 值越大表示检测性能越好
  - 1.0 表示完美检测，0.5 表示随机猜测

- **ROC 曲线**: 展示不同阈值下的真阳性率和假阳性率

- **混淆矩阵**: 展示预测结果与真实标签的对比

## 预期结果

根据 MVTec AD 数据集的特性，预期性能：

- **AUROC**: 通常可以达到 0.85-0.98（取决于类别和异常类型）
- **可视化**: 热力图能够较好地定位异常区域

## 技术细节

### 特征提取流程

1. 图像预处理：调整大小、归一化（ImageNet 标准）
2. 通过 Wide ResNet50-2 前向传播
3. 提取 Layer2 和 Layer3 的特征图
4. 上采样 Layer3 特征图到 Layer2 的尺寸
5. 拼接两层特征，形成融合特征图

### 异常分数计算

1. 将特征图划分为多个图像块（patches）
2. 对每个图像块计算与正常分布的马氏距离
3. 将马氏距离重塑为异常分数图
4. 使用最大值池化获得图像级异常分数

### 热力图生成

1. 对异常分数图进行高斯平滑
2. 调整到原始图像尺寸
3. 归一化到 [0, 255] 范围
4. 应用 JET 颜色映射
5. 与原始图像叠加显示

## 注意事项

1. **GPU 支持**: 建议使用 GPU 加速（CUDA），CPU 运行会较慢
2. **内存要求**: 处理大批量图像需要足够的内存
3. **标签文件**: 确保 `image_anomaly_labels.json` 文件格式正确
4. **数据路径**: 确保数据集路径配置正确
5. **中文显示**: 代码已配置中文字体支持（SimHei），如无此字体可能需要调整

## 参数调整建议

- **image_size**: 可以尝试 224、256、512 等不同尺寸
- **batch_size**: 根据 GPU 内存调整，通常 8-32
- **特征层选择**: 可以尝试其他层的组合
- **平滑参数**: 调整 `gaussian_filter` 的 `sigma` 参数影响热力图平滑程度

